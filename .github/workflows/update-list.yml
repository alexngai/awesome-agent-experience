name: Update Awesome List

on:
  # Run biweekly on the 1st and 15th at 9am UTC
  schedule:
    - cron: "0 9 1,15 * *"

  # Allow manual trigger from Actions tab
  workflow_dispatch:
    inputs:
      scope:
        description: "Research scope"
        required: false
        default: "all"
        type: choice
        options:
          - all
          - standards
          - tools
          - articles
          - case-studies

  # Trigger via issue with label
  issues:
    types: [labeled]

jobs:
  update:
    # Schedule and dispatch always run; issue label requires owner/collaborator
    if: |
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      (
        github.event_name == 'issues' &&
        github.event.label.name == 'update-list' &&
        contains(fromJSON('["OWNER","MEMBER","COLLABORATOR"]'), github.event.issue.author_association)
      )
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            You have a skill at .claude/skills/update-awesome-list.md -- read it first.

            Research scope: ${{ github.event.inputs.scope || 'all' }}

            ${{ github.event_name == 'issues' && format('Additional context from the issue that triggered this run:\n{0}', github.event.issue.body) || '' }}

            Follow the skill instructions to research and update the awesome list.
            Focus on content from the last 30 days.
            After making changes, commit directly to main and push.

            If you find no new items worth adding, do not commit. Instead just
            report that the list is up to date.
          claude_args: >-
            --max-turns 30
            --allowedTools
            WebSearch
            WebFetch
            Read
            Edit
            Write
            Glob
            Grep
            Task
            TodoWrite
            Skill
            Bash(git:*)
            Bash(curl:*)
            Bash(gh:*)
            Bash(mkdir:*)
            Bash(ls:*)
            Bash(wc:*)
            Bash(date:*)

      - name: Close trigger issue
        if: github.event_name == 'issues'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue close ${{ github.event.issue.number }} \
            --comment "Update workflow completed. Check open PRs for results."
