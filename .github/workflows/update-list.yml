name: Update Awesome List

on:
  # Run monthly on the 1st at 9am UTC
  schedule:
    - cron: "0 9 1 * *"

  # Allow manual trigger from Actions tab
  workflow_dispatch:
    inputs:
      scope:
        description: "Research scope"
        required: false
        default: "all"
        type: choice
        options:
          - all
          - standards
          - tools
          - articles
          - case-studies

  # Trigger via issue with label
  issues:
    types: [labeled]

jobs:
  update:
    # Only run on schedule/dispatch, or when 'update-list' label is added
    if: |
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issues' && github.event.label.name == 'update-list')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            You have a skill at .claude/skills/update-awesome-list.md -- read it first.

            Research scope: ${{ github.event.inputs.scope || 'all' }}

            ${{ github.event_name == 'issues' && format('Additional context from the issue that triggered this run:\n{0}', github.event.issue.body) || '' }}

            Follow the skill instructions to research and update the awesome list.
            Focus on content from the last 30 days.
            After making changes, commit to a new branch and open a PR.

            If you find no new items worth adding, do not create a PR. Instead just
            report that the list is up to date.
          claude_args: >-
            --max-turns 30
            --allowedTools
            WebSearch
            WebFetch
            Read
            Edit
            Write
            Glob
            Grep
            Task
            TodoWrite
            Skill
            Bash(git:*)
            Bash(curl:*)
            Bash(gh:*)
            Bash(mkdir:*)
            Bash(ls:*)
            Bash(wc:*)
            Bash(date:*)

      - name: Close trigger issue
        if: github.event_name == 'issues'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue close ${{ github.event.issue.number }} \
            --comment "Update workflow completed. Check open PRs for results."
